<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>Action Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#settingModal">
        Settings
    </button>
    <!-- Fixed sidebar content placement -->
    <div class="container-fluid">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar p-3">
                <h4>Actions</h4>
                <div class="d-flex mb-3 gap-2">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#actionModal">
                        New Action
                    </button>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#pathModal">
                        New Category
                    </button>
                </div>
                <br>
                <!-- Moved sidebar menu items here -->
                <div class="list-group">
                    {% for key, value in action_dict.items %}
                        <div class="folder-container" data-theme="dark">
                            <div class="folder-header list-group-item" onclick="toggleFolder(this)">
                                <span class="caret">▶</span>
                                {{ key }}
                            </div>
                            <div class="folder-contents" style="display: none; margin-left: 20px;">
                                {% if value.items %}
                                    {# Recursive template for subfolders #}
                                    {% include template_f with action_dict=value template_f=template_f %}
                                {% else %}
                                    {# List files #}
                                    {% for item in value %}
                                        <div class="list-group-item">
                                            {{ item.name }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 p-3">
                <h4>Action Order</h4>
                <div id="sortable" class="list-group">
                    {% for action in ordered_actions %}
                    <div class="list-group-item action-list" data-id="{{ action.id }}">
                        {{ action.name }}
                        <div class="float-end">
                            <button class="btn btn-sm btn-outline-secondary move-up">↑</button>
                            <button class="btn btn-sm btn-outline-secondary move-down">↓</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- New Action Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'create_action' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">New Action</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        {{ form_a.as_p }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- New Show Modal -->
    <div class="modal fade" id="showModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'create_show' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">New Show</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        {{ form_c.as_p }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- New Path Modal -->
    <div class="modal fade" id="pathModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'create_path' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">New Category</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        {{ form_b.as_p }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingModal" tabindex="-1">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            });
            </script>
        <div class="modal-dialog">
            <div class="modal-content" style="padding: 2rem;">
    
                <h5 class="modal-title">Settings</h5>
            
                <form method="post">
                    {% csrf_token %}
                    <div>
                        <h3>Appearance:</h3>
                        <div>
                            <div >
                                {% for choice in form_s.theme %}
                                <label style="padding: 0.5rem 1rem; border: 1px solid #4a5568; border-radius: 4px; cursor: pointer;">
                                    {{ choice.tag }} {{ choice.choice_label }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
            
                    <div>
                        <h3>Key Bindings:</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    // Target ALL buttons with class "recbut"
                                    const recordButtons = document.querySelectorAll('button.recbut');
                                    let activeInput = null;
                            
                                    // Add event listeners to ALL buttons
                                    recordButtons.forEach(button => {
                                        button.addEventListener('click', function() {
                                            activeInput = this.nextElementSibling;
                                            this.textContent = 'Press any key...';
                                            this.style.background = '#e53e3e';
                                        });
                                    });
                            
                                    document.addEventListener('keydown', function(e) {
                                        if (activeInput) {
                                            e.preventDefault();
                                            const display = activeInput.nextElementSibling;
                                            const button = activeInput.previousElementSibling;
                                            
                                            activeInput.value = e.keyCode;
                                            display.textContent = `${e.key} (${e.keyCode})`;
                                            button.textContent = 'Record Key';
                                            button.style.background = '#4a5568';
                                            activeInput = null;
                                        }
                                    });
                                });
                            </script>
                            <div>
                                <label>{{ form_s.go_key.label }}</label>
                                <div style="display: flex; gap: 5%; margin-top: 5%;">
                                    <button class="recbut" type="button">
                                        Record Key
                                    </button>
                                    {{ form_s.go_key }}
                                    <span class="key-display"></span>
                                </div>
                            </div>
                            <div>
                                <label>{{ form_s.stop_key.label }}</label>
                                <div style="display: flex; gap: 5%; margin-top: 5%;">
                                    <button class="recbut" type="button">
                                        Record Key
                                    </button>
                                    {{ form_s.stop_key }}
                                    <span class="key-display"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% comment %} <div>
                        <h3 style="margin-bottom: 1rem;">MIDI Settings</h3>
                        <div>
                            <label>{{ form_s.midi_device.label }}</label>
                            {{ form_s.midi_device }}
                        </div>
                    </div> {% endcomment %}
                    <div>
                        <h3>Show</h3>
                        <div>
                            <select name="{{ form_s.show_current.name }}" 
                                    style="width: 100%; 
                                        padding: 0.5rem; 
                                        background: #1a202c; 
                                        color: white; 
                                        border: 1px solid #4a5568;
                                        border-radius: 4px;
                                        margin-top: 0.5rem;">
                                {% for value, label in form_s.show_current.field.choices %}
                                <option value="{{ value }}" 
                                        {% if form_s.show_current.value == value %}selected{% endif %}
                                        style="background: #2d3748; color: white;">
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <button type="button" class="addbut" data-bs-toggle="modal" data-bs-target="#showModal">
                                New Show
                            </button>
                    </div>
                    <button type="submit" class="savebut">
                        Save Settings
                    </button>
                    
                </form>
            </div>
        </div>
        
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.move-up').click(function() {
                const $item = $(this).closest('.list-group-item');
                const $prev = $item.prev();
                if ($prev.length) {
                    $item.insertBefore($prev);
                    updateOrder();
                }
            });

            $('.move-down').click(function() {
                const $item = $(this).closest('.list-group-item');
                const $next = $item.next();
                if ($next.length) {
                    $item.insertAfter($next);
                    updateOrder();
                }
            });

            function updateOrder() {
                const order = [];
                $('#sortable .list-group-item').each(function() {
                    order.push($(this).data('id'));
                });
                
                $.post("{% url 'reorder_actions' %}", {
                    order: JSON.stringify(order),
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                });
            }
        });
        function toggleFolder(element) {
            const contents = element.nextElementSibling;
            const caret = element.querySelector('.caret');
            if (contents.style.display === 'none') {
                contents.style.display = 'block';
                caret.innerHTML = '▼';
            } else {
                contents.style.display = 'none';
                caret.innerHTML = '▶';
            }
        }
    </script>
</body>
</html>